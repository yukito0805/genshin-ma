<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>原神マップ：瞳・宝箱・チャレンジ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100%; }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .controls button {
      margin: 2px;
      padding: 6px 12px;
      cursor: pointer;
    }
    .map-selector {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: right 0.3s ease;
    }
    .reset-button {
      margin-top: 10px;
      padding: 6px 12px;
      cursor: pointer;
    }
    @media (max-width: 768px) {
      .map-selector {
        top: auto;
        bottom: 10px;
        right: 10px;
      }
      .map-selector, .pin-selector {
        right: -160px;
      }
      .map-selector:hover, .pin-selector:hover {
        right: 0;
      }
    }
  </style>
</head>
<body>
  <div id="controls">
    <select id="marker-type">
      <option value="" selected disabled>選択してください</option>
      <option value="hujin">瞳</option>
      <option value="takara">宝箱</option>
      <option value="challenge">チャレンジ</option>
    </select>
    <input type="text" id="marker-number" placeholder="番号（任意）">
    <button id="save-btn">保存</button>
    <button id="clear-btn">全削除</button>
  </div>

  <div id="map"></div>

  <!-- Leaflet JS 読み込み -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -5, // ズームの最小値。変更可能
      maxZoom: 2,  // ズームの最大値。変更可能
      zoomSnap: 0.1, // ズームの刻み幅。変更可能
      zoomDelta: 0.5 // ズーム時の変動幅。変更可能
    });

    const maps = {
      mond: { url: 'images/mond_map.jpg', size: [3000, 1722] },
      liyue1: { url: 'images/liyue1.jpg', size: [3000, 1722] },
      liyue2: { url: 'images/liyue2.jpg', size: [3000, 1722] }
    };

    let currentMap = 'mond'; 
    let currentType = '';  // 初期状態は「何も選択されていない」
    let overlay, imageBounds;

    const baseIconSize = 20; 

    function createIcon(type, size = baseIconSize) {
      let url = '';
      let anchor = [size / 2, size];
      if (type === 'hujin') {
        url = (currentMap === 'mond') ? 'images/hujin.jpg' : 'images/iwagami.jpg';
      } else if (type === 'takara') {
        url = 'images/takara.png';
      } else {
        url = 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png';
        anchor = [size / 2, size];
      }
      return L.icon({ iconUrl: url, iconSize: [size, size], iconAnchor: anchor });
    }

    const markerLayer = L.layerGroup().addTo(map);

    function switchMap(mapName) {
      currentMap = mapName; 
      if (overlay) map.removeLayer(overlay);
      const size = maps[mapName].size;
      imageBounds = [[0, 0], [size[1], size[0]]];
      overlay = L.imageOverlay(maps[mapName].url, imageBounds).addTo(map);
      map.setMaxBounds(imageBounds); 
      map.fitBounds(imageBounds); 
      loadMarkers();
    }

    function setCurrentType(type) {
      currentType = type;
    }

    function saveMarkers() {
      const markers = [];
      markerLayer.eachLayer(layer => {
        markers.push({
          lat: layer.getLatLng().lat,
          lng: layer.getLatLng().lng,
          type: layer.options.customType || 'challenge'
        });
      });
      localStorage.setItem('mapMarkers_' + currentMap, JSON.stringify(markers));
    }

    function resetMarkers() {
      markerLayer.clearLayers();
      localStorage.removeItem('mapMarkers_' + currentMap);
    }

    function updateMarkerIcons() {
      markerLayer.eachLayer(layer => {
        const type = layer.options.customType;
        const icon = createIcon(type, baseIconSize * map.getZoomScale(map.getZoom(), 0));
        layer.setIcon(icon);
      });
    }

    map.on('zoomend', updateMarkerIcons);

    map.on('click', function (e) {
      const { lat, lng } = e.latlng;
      if (!currentType) return;  // 「タイプが選ばれていない時はマーカーを置かない」
      
      const clickDistance = 5;
      
      let removed = false;
      
      markerLayer.eachLayer(layer => {
        if (map.distance(layer.getLatLng(), e.latlng) < clickDistance) {
          markerLayer.removeLayer(layer); 
          removed = true;
        }
      });

      if (!removed) {
        const zoomScale = Math.pow(map.getZoomScale(map.getZoom(), 0), 0.4);
        const icon = createIcon(currentType, baseIconSize * zoomScale);
        const marker = L.marker([lat, lng], { icon: icon }).addTo(markerLayer);
        marker.options.customType = currentType;
      }
      saveMarkers();
    });

    switchMap('mond');

    // 初期設定を「何も選択されていない」状態に
    document.getElementById('marker-type').addEventListener('change', function() {
      setCurrentType(this.value); 
    });

    // 保存ボタンの処理
    document.getElementById('save-btn').addEventListener('click', function() {
      const markerNumber = document.getElementById('marker-number').value;
      if (currentType && markerNumber) {
        // 保存処理
        alert("保存されました！");
      }
    });

    // 全削除ボタンの処理
    document.getElementById('clear-btn').addEventListener('click', resetMarkers);
  </script>
</body>

</html>
