<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>原神マップ：瞳・宝箱・チャレンジ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body {
      height: 100%; margin: 0; padding: 0;
    }
    #map {
      height: 100%;
    }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .controls button {
      margin: 2px;
      padding: 6px 12px;
      cursor: pointer;
    }
    .map-selector {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 1000;
  background: white;
  padding: 10px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  transition: right 0.3s ease;
    }
    .reset-button {
      margin-top: 10px;
      padding: 6px 12px;
      cursor: pointer;
    }
@media (max-width: 768px) {
    .map-selector {
      top: auto;
      bottom: 10px;
      right: 10px;
    }
  }
@media (max-width: 768px) {
  .map-selector, .pin-selector {
    right: -160px; /* 幅に応じて調整、完全に隠す */
  }

  /* タップやホバー時に表示 */
  .map-selector:hover, .pin-selector:hover {
    right: 0;
  }
}
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="controls">
    <strong>ピン選択：</strong>
    <button onclick="setCurrentType('hujin')">瞳</button>
    <button onclick="setCurrentType('takara')">宝箱</button>
    <button onclick="setCurrentType('challenge')">チャレンジ</button>
    <button class="reset-button" onclick="resetMarkers()">チェック全削除</button>
  </div>

  <div class="map-selector">
    <strong>マップ切替：</strong><br>
    <button onclick="switchMap('mond')">モンド</button>
    <button onclick="switchMap('liyue1')">璃月1</button>
    <button onclick="switchMap('liyue2')">璃月2</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
const map = L.map('map', {
  crs: L.CRS.Simple,
  minZoom: -5, // ズームの最小値。変更可能
  maxZoom: 2,  // ズームの最大値。変更可能
  zoomSnap: 0.1, // ズームの刻み幅。変更可能
  zoomDelta: 0.5 // ズーム時の変動幅。変更可能
});

const maps = {
  mond: { url: 'images/mond_map.jpg', size: [3000, 1722] }, // ここでマップのサイズを変更可能
  liyue1: { url: 'images/liyue1.jpg', size: [3000, 1722] },
  liyue2: { url: 'images/liyue2.jpg', size: [3000, 1722] }
};

let currentMap = 'mond'; // 初期地図（'mond'）の設定。変更可能
let currentType = 'hujin'; // 初期アイコンの設定。変更可能
let overlay, imageBounds;

const baseIconSize = 20; // 通常サイズの半分（ズームで変動）
// baseIconSizeの値を変更すれば、アイコンの基本サイズを変えられます

function createIcon(type, size = baseIconSize) {
  let url = '';
  let anchor = [size / 2, size];
  if (type === 'hujin') {
    url = (currentMap === 'mond') ? 'images/hujin.jpg' : 'images/iwagami.jpg';
  } else if (type === 'takara') {
    url = 'images/takara.png';
  } else {
    url = 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png';
    anchor = [size / 2, size];
  }
  return L.icon({ iconUrl: url, iconSize: [size, size], iconAnchor: anchor });
}

const markerLayer = L.layerGroup().addTo(map);

function switchMap(mapName) {
  currentMap = mapName; // 地図の切り替え時に使用する
  if (overlay) map.removeLayer(overlay);
  const size = maps[mapName].size; // マップサイズを参照。変更可能
  imageBounds = [[0, 0], [size[1], size[0]]];
  overlay = L.imageOverlay(maps[mapName].url, imageBounds).addTo(map);
  map.setMaxBounds(imageBounds); // マップの表示範囲を設定。変更可能
  map.fitBounds(imageBounds); // マップをフィットさせる
  loadMarkers();
}

function setCurrentType(type) {
  currentType = type; // アイコンタイプの変更
}

function saveMarkers() {
  const markers = [];
  markerLayer.eachLayer(layer => {
    markers.push({
      lat: layer.getLatLng().lat,
      lng: layer.getLatLng().lng,
      type: layer.options.customType || 'challenge'
    });
  });
  localStorage.setItem('mapMarkers_' + currentMap, JSON.stringify(markers)); // マーカー情報の保存
}

function resetMarkers() {
  markerLayer.clearLayers(); // マーカーをリセット
  localStorage.removeItem('mapMarkers_' + currentMap); // ローカルストレージのリセット
}

function updateMarkerIcons() {
  markerLayer.eachLayer(layer => {
    const type = layer.options.customType;
    const icon = createIcon(type, baseIconSize * map.getZoomScale(map.getZoom(), 0)); // アイコンのサイズ更新
    layer.setIcon(icon);
  });
}

map.on('zoomend', updateMarkerIcons);

map.on('click', function (e) {
  const { lat, lng } = e.latlng;
  let removed = false;
  
  const clickDistance = 50; // 距離判定を50ピクセルに変更（30ピクセルから）
  
  markerLayer.eachLayer(layer => {
    if (map.distance(layer.getLatLng(), e.latlng) < clickDistance) {
      markerLayer.removeLayer(layer); // 近すぎる場合にマーカーを消す
      removed = true;
    }
  });

  if (!removed) {
    const zoomScale = Math.pow(map.getZoomScale(map.getZoom(), 0), 0.4);
    const icon = createIcon(currentType, baseIconSize * zoomScale);
    const marker = L.marker([lat, lng], { icon: icon }).addTo(markerLayer);
    marker.options.customType = currentType;
  }
  saveMarkers();
});

switchMap('mond'); // 初期地図の読み込み

// 変更可能メモ:
// - ズームの最小値（minZoom）や最大値（maxZoom）の変更
// - baseIconSizeを変更してアイコンのサイズを調整（ズーム時の変動にも対応）
// - 地図の画像サイズや位置など（mapsオブジェクト内）
// - アイコンのURLを変更して異なる画像を表示する
// - ローカルストレージへの保存項目やデータを変更

  </script>
</body>
</html>

